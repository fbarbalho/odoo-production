name: Deploy Odoo to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to Hetzner VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          cd /opt/odoo
          
          # Backup antes do deploy
          echo "ğŸ—„ï¸ Fazendo backup..."
          if [ -f "./backup.sh" ]; then
            ./backup.sh
          fi
          
          # Verificar se Ã© primeira execuÃ§Ã£o
          if [ ! -d ".git" ]; then
            echo "ğŸ“¥ Primeira execuÃ§Ã£o - inicializando Git..."
            git init
            git remote add origin https://github.com/fbarbalho/odoo-production.git
          fi
          
          # Atualizar cÃ³digo
          echo "ğŸ“¥ Atualizando cÃ³digo..."
          git fetch origin main
          git reset --hard origin/main
          
          # Verificar se .env existe
          if [ ! -f ".env" ]; then
            echo "âš ï¸ Arquivo .env nÃ£o encontrado! Copiando exemplo..."
            cp .env.example .env
            echo "ğŸ”§ ATENÃ‡ÃƒO: Edite o arquivo .env com sua senha!"
          fi
          
          # Tornar scripts executÃ¡veis
          chmod +x *.sh
          
          # Verificar se precisa rebuild
          if git diff HEAD~1 HEAD --name-only 2>/dev/null | grep -q -E "(docker-compose\.yml|Dockerfile)"; then
            echo "ğŸ”§ Rebuild necessÃ¡rio..."
            docker-compose down
            docker-compose up -d --build
          else
            echo "ğŸ”„ Restart simples..."
            docker-compose up -d
          fi
          
          # Aguardar containers
          echo "â³ Aguardando containers inicializarem..."
          sleep 45
          
          # Verificar se estÃ¡ funcionando
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… Deploy concluÃ­do com sucesso!"
            echo "ğŸŒ Odoo disponÃ­vel em: http://$(curl -s ifconfig.me):8069"
          else
            echo "âŒ Erro no deploy - verificando logs..."
            docker-compose logs --tail=20
            exit 1
          fi
